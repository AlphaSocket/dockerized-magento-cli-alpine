#!/bin/sh

#
# Local test script to test docker images
#

# exit if a command fails
set -e

CURL=$(which curl)
DOCKER=$(which docker)

if [ CURL = '' ]; then
    echo 'The package curl is required\n'
    exit 1
fi

if [ DOCKER = '' ]; then
    echo 'Docker is required\n'
    exit 1
fi

echo "#\n# Cleaning docker\n#\n"
running_containers=$(docker ps -aq)
if [ "$running_containers" ] 
    then
        docker stop $running_containers -t 0 && docker system prune -f
fi
echo "# Cleaned"

echo "#\n# Running test\n#\n"
# Starting magento-cli container
echo "### Starting magento-cli container..."
TEST_CONTAINER_MAGENTO_CLI_ID=$( docker run -d --name=magento-cli-alpine 03192859189254/magento-cli-alpine:latest-dev )
TEST_CONTAINER_MAGENTO_CLI_STATUS=$(sleep 5 && docker inspect -f '{{.State.Running}}' $TEST_CONTAINER_MAGENTO_CLI_ID)

# Testing magento-cli container
echo "### Testing magento-cli container..."
if [ "$TEST_CONTAINER_MAGENTO_CLI_STATUS" = "true" ]; then
    echo "### Test Succeeded\n";
docker logs $TEST_CONTAINER_MAGENTO_CLI_ID;
fi


exit 0